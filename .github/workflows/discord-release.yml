name: Discord Release Notification

on:
  release:
    types: [published]

jobs:
  notify-discord:
    runs-on: ubuntu-latest
    steps:
      - name: Post release to Discord
        uses: actions/github-script@v7
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_RELEASE_WEBHOOK }}
        with:
          script: |
            const release = context.payload.release;

            // Truncate body to fit Discord embed limit (4096 chars)
            let body = release.body || 'No release notes provided.';
            if (body.length > 3900) {
              body = body.substring(0, 3900) + '\n\n*... truncated. See full release notes on GitHub.*';
            }

            const embed = {
              title: `HamTab ${release.tag_name}`,
              url: release.html_url,
              description: body,
              color: 0x2ECC71, // green
              footer: { text: 'HamTab Release' },
              timestamp: release.published_at
            };

            const response = await fetch(process.env.WEBHOOK_URL, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ embeds: [embed] })
            });

            if (!response.ok) {
              throw new Error(`Discord webhook failed: ${response.status} ${response.statusText}`);
            }

            console.log(`Posted release ${release.tag_name} to Discord`);
